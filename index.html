<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIQUIDACION MKP – Consolidado Sellers</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  :root{
    --bg:#0c1018; --card:#121827; --muted:#93a1b1; --text:#e6eaf2; --brand:#22d3ee; --brand2:#6366f1; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 600px at 10% -10%,#0f162a 0%,transparent 60%),linear-gradient(180deg,#0b1220,#0c1018);color:var(--text)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 20px}
  header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:18px}
  h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.2px}
  .badge{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#081018;font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{grid-column:span 12;background:linear-gradient(180deg,#121827,#0e1422);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px;box-shadow:0 0 0 1px rgba(99,102,241,.08) inset}
  @media(min-width:960px){.card.half{grid-column:span 6}}
  .card h2{margin:0 0 10px 0;font-size:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .file{display:flex;align-items:center;gap:10px;padding:10px;border:1px dashed rgba(255,255,255,.2);border-radius:10px;background:#0c1324}
  .file input{display:none}
  .file label{cursor:pointer;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#081018;font-weight:700;padding:8px 12px;border-radius:10px}
  .hint{font-size:12px;color:var(--muted)}
  select,button,input[type="text"],input[type="number"],.pill{
    background:#0b1222;color:var(--text);border:1px solid rgba(255,255,255,.12);
    border-radius:10px;padding:8px 10px;outline:none
  }
  button.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#061018;border:none;font-weight:800}
  button.ghost{background:#0b1222;border:1px solid rgba(255,255,255,.16)}
  .map-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .map-item{display:flex;flex-direction:column;gap:6px}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .item{background:#0b1222;border:1px solid rgba(255,255,255,.1);padding:10px 12px;border-radius:10px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  details{background:#0b1222;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  details>summary{cursor:pointer;font-weight:700;margin:-10px;padding:10px}
  .footer{margin-top:18px;font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>LIQUIDACION MKP – Consolidado Sellers</h1>
    <div class="badge">Vercel Ready</div>
  </header>

  <div class="grid">
    <div class="card half">
      <h2>1) Archivos de entrada</h2>
      <div class="row">
        <div class="file"><label for="fVTEX">Subir Base VTEX</label><input id="fVTEX" type="file" accept=".xlsx,.xls,.csv" /></div>
        <div class="file"><label for="fDEV">Subir Devoluciones</label><input id="fDEV" type="file" accept=".xlsx,.xls,.csv" /></div>
        <div class="file"><label for="fCOM">Subir Comisiones</label><input id="fCOM" type="file" accept=".xlsx,.xls,.csv" /></div>
        <div class="file"><label for="fTAS">Subir Tasas</label><input id="fTAS" type="file" accept=".xlsx,.xls,.csv" /></div>
        <div class="file"><label for="fDEC">Subir Decidir / Gateway</label><input id="fDEC" type="file" accept=".xlsx,.xls,.csv" /></div>
      </div>
      <div class="hint">Acepta XLSX/XLS/CSV. Si Decidir no trae órdenes, igual se prorratea por seller+mes.</div>
    </div>

    <div class="card half">
      <h2>2) Parámetros</h2>
      <div class="row">
        <div class="pill">Periodo: <input id="periodoLabel" class="mono" value="16 Sep al 15 Oct" /></div>
        <div class="pill">Mes de liquidación (texto): <input id="mesLabel" class="mono" value="Septiembre" /></div>
        <div class="pill">Detectar BSF por Decidir (BIN/Issuer): 
          <select id="detectarBSF"><option value="si" selected>Sí</option><option value="no">No</option></select>
        </div>
        <div class="pill">Formato salida:
          <select id="fmt"><option value="xlsx" selected>XLSX</option><option value="csv">CSV</option></select>
        </div>
      </div>
      <div class="hint">“Periodo” y “Mes de liquidación” se vuelcan en la columna <b>Fechas Liquidacion</b> y para etiquetas.</div>
    </div>

    <div class="card">
      <h2>3) Mapeo de columnas (opcional / recomendado)</h2>
      <details>
        <summary>Ver/editar mapeos</summary>
        <div class="grid" style="margin-top:10px">
          <div class="card half" id="mapVTEX">
            <h3>VTEX</h3>
            <div class="map-grid" id="mapVTEXGrid"></div>
          </div>
          <div class="card half" id="mapDEV">
            <h3>Devoluciones</h3>
            <div class="map-grid" id="mapDEVGrid"></div>
          </div>
          <div class="card half" id="mapCOM">
            <h3>Comisiones</h3>
            <div class="map-grid" id="mapCOMGrid"></div>
            <div class="hint">Esperado: Seller, Emisor/Brand (BSF/Otro/Visa/Master), Cuotas (opcional), Comisión %</div>
          </div>
          <div class="card half" id="mapTAS">
            <h3>Tasas</h3>
            <div class="map-grid" id="mapTASGrid"></div>
            <div class="hint">Esperado: Cuotas, TD% Con BSF, TD% Sin BSF</div>
          </div>
          <div class="card half" id="mapDEC">
            <h3>Decidir / Gateway</h3>
            <div class="map-grid" id="mapDECGrid"></div>
            <div class="hint">Si no trae <i>Order</i>, se toma como resumen por Seller/Mes y se prorratea CF/Intereses.</div>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <h2>4) Procesar</h2>
      <div class="row">
        <button class="ghost" id="btnAnalizar">Analizar & Validar</button>
        <button class="primary" id="btnGenerar">Generar LIQUIDACION</button>
      </div>
      <div class="kpi" id="kpi"></div>
      <details id="logbox" style="margin-top:12px">
        <summary>Log de transformaciones (CSV)</summary>
        <div class="row" style="margin:8px 0">
          <button class="ghost" id="btnLog">Descargar Log</button>
        </div>
        <div style="max-height:220px;overflow:auto;font-size:12px" id="logpre" class="mono"></div>
      </details>
    </div>

    <div class="card">
      <h2>5) Resultado</h2>
      <div class="row">
        <button id="btnDescargar" class="primary" disabled>Descargar Archivo</button>
      </div>
      <div class="footer">Estructura de salida: hoja <b>LIQUIDACION</b> con columnas exactas requeridas.</div>
    </div>
  </div>
</div>

<script>
/** Utils **/
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const inferHeaders = (arr)=> arr.length ? Object.keys(arr[0]||{}) : [];
const normalizeHeader = s => (s||"").toString().trim().toLowerCase()
  .replace(/\s+/g,' ').replace(/[._-]/g,' ').replace(/\s+/g,' ').trim();
const asNumber = (v)=> {
  if (typeof v === 'number' && !isNaN(v)) return v;
  if (typeof v === 'string') {
    const x = v.replace(/\./g,'').replace(/,/g,'.').replace(/[^0-9.-]/g,'');
    const n = parseFloat(x);
    return isNaN(n)?0:n;
  }
  if (v instanceof Date) return +v; // not used
  return v? Number(v): 0;
};
const fmtPct = x => (x==null? '': (Math.round(x*10000)/100).toFixed(2)+'%');
const isTruthy = v => v===true || v==='true' || v==='sí' || v==='si' || v==='1' || v===1;

/** Global state **/
const state = {
  raw:{VTEX:null, DEV:null, COM:null, TAS:null, DEC:null},
  maps:{VTEX:{}, DEV:{}, COM:{}, TAS:{}, DEC:{}},
  log:[],
  outRows:[],
  blob:null,
  isDecidirGranular:false
};

const REQUIRED_OUTPUT_COLUMNS = [
  'Fechas Liquidacion','Numero de orden','Order','Tipo de Comprobante','Fecha de Comprobante',
  'Importe Producto','Descuentos','Envio','Importe Total','Comisión (%)','Importe Comisión (AR$)',
  'Cantidad Total de Cuotas','Costo Financiero (%)','Costo Financiero (AR$) asumido por el seller',
  'Intereses asumidos por el cliente','Total sin impuestos','Seller'
];

/** File readers **/
async function readFile(file){
  const buf = await file.arrayBuffer();
  const isCSV = /\.csv$/i.test(file.name);
  if (isCSV){
    const data = new TextDecoder().decode(new Uint8Array(buf));
    const wb = XLSX.read(data,{type:'string'});
    const sheet = wb.SheetNames[0];
    return XLSX.utils.sheet_to_json(wb.Sheets[sheet],{defval:null});
  } else {
    const wb = XLSX.read(buf,{type:'array'});
    const sheet = wb.SheetNames[0];
    return XLSX.utils.sheet_to_json(wb.Sheets[sheet],{defval:null});
  }
}

function mountMapUI(containerId, sampleHeaders, defaultMap){
  const cont = document.getElementById(containerId+'Grid');
  if(!cont) return;
  cont.innerHTML = '';
  const makeSelect = (name, candidates=[])=>{
    const sel = document.createElement('select'); sel.className='mono';
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(no mapear)'; sel.appendChild(opt0);
    candidates.forEach(h=>{
      const o=document.createElement('option'); o.value=h; o.textContent=h; sel.appendChild(o);
    });
    if(defaultMap && defaultMap[name]){
      const wanted = defaultMap[name];
      const idx = candidates.find(h=> normalizeHeader(h)===normalizeHeader(wanted));
      if(idx){ sel.value = candidates.find(h=> normalizeHeader(h)===normalizeHeader(wanted));}
    }
    return sel;
  };
  const addRow = (label, key, candidates)=>{
    const box = document.createElement('div'); box.className='map-item';
    const lab = document.createElement('label'); lab.textContent = label; lab.style.fontSize='12px'; lab.style.opacity=.9;
    const sel = makeSelect(key, candidates);
    sel.dataset.key = key;
    box.appendChild(lab); box.appendChild(sel);
    cont.appendChild(box);
  };

  // VTEX/DEV expected fields
  if(containerId==='mapVTEX' || containerId==='mapDEV'){
    const expect = ['Numero de orden','Order','Tipo de Comprobante','Fecha de Comprobante','Importe Producto','Descuentos','Envio','Importe Total','Cantidad Total de Cuotas','Seller','Emisor','Intereses asumidos por el cliente'];
    // heuristics defaults
    const heur = {};
    sampleHeaders.forEach(h=>{
      const n = normalizeHeader(h);
      if(n.includes('numero de orden') || n==='numero de orden') heur['Numero de orden']=h;
      if(n==='order' || n.includes('order')) heur['Order']=h;
      if(n.includes('tipo de comprobante')) heur['Tipo de Comprobante']=h;
      if(n.includes('fecha de comprobante')) heur['Fecha de Comprobante']=h;
      if(n.includes('importe producto')) heur['Importe Producto']=h;
      if(n==='descuentos' || n.includes('descuento')) heur['Descuentos']=h;
      if(n==='envio' || n.includes('envío')) heur['Envio']=h;
      if(n.includes('importe total')) heur['Importe Total']=h;
      if(n.includes('cuotas')) heur['Cantidad Total de Cuotas']=h;
      if(n==='seller' || n.includes('seller')) heur['Seller']=h;
      if(n.includes('emisor')||n.includes('banco')||n.includes('issuer')) heur['Emisor']=h;
      if(n.includes('interes')||n.includes('interés')) heur['Intereses asumidos por el cliente']=h;
    });
    expect.forEach(e => addRow(e,e, sampleHeaders));
    // set defaults
    [...cont.querySelectorAll('select')].forEach(sel=>{
      const key = sel.dataset.key;
      if(heur[key]) sel.value = heur[key];
    });
  }

  // COM expected
  if(containerId==='mapCOM'){
    const expect = ['Seller','Emisor/Brand','Cuotas','Comisión (%)'];
    expect.forEach(e=> addRow(e,e, sampleHeaders));
  }
  // TAS expected
  if(containerId==='mapTAS'){
    const expect = ['Cuotas','TD% Con BSF','TD% Sin BSF'];
    // heuristic
    const heur = {};
    sampleHeaders.forEach(h=>{
      const n=normalizeHeader(h);
      if(n.startsWith('cuota')) heur['Cuotas']=h;
      if(n.includes('con bsf')||n.includes('bsf')) heur['TD% Con BSF']=h;
      if(n.includes('sin bsf')||n.includes('no bsf')) heur['TD% Sin BSF']=h;
    });
    expect.forEach(e=> addRow(e,e, sampleHeaders));
    [...cont.querySelectorAll('select')].forEach(sel=>{
      const key=sel.dataset.key; if(heur[key]) sel.value=heur[key];
    });
  }
  // DEC expected
  if(containerId==='mapDEC'){
    const expect = ['Order','Numero de orden','Fecha','BIN/Issuer','Brand','Cuotas','CF AR$','Interes Cliente AR$','Seller','Mes'];
    expect.forEach(e=> addRow(e,e, sampleHeaders));
  }
}

function grabMap(containerId){
  const grid = document.getElementById(containerId+'Grid');
  const map = {};
  if(!grid) return map;
  grid.querySelectorAll('select').forEach(sel=>{
    map[ sel.dataset.key ] = sel.value || null;
  });
  return map;
}

function setKPI(msgs){
  const box = document.getElementById('kpi');
  box.innerHTML = '';
  msgs.forEach(m=>{
    const d=document.createElement('div'); d.className='item';
    d.textContent = m; box.appendChild(d);
  });
}

function pushLog(line){ state.log.push(line); }
function renderLogPreview(){
  const pre = document.getElementById('logpre');
  pre.textContent = state.log.join('\n');
}

/** Core loaders **/
async function handleLoad(which, file){
  const data = await readFile(file);
  state.raw[which] = data;
  const headers = inferHeaders(data);
  // mount map uis:
  if(which==='VTEX') mountMapUI('mapVTEX', headers);
  if(which==='DEV')  mountMapUI('mapDEV', headers);
  if(which==='COM')  mountMapUI('mapCOM', headers);
  if(which==='TAS')  mountMapUI('mapTAS', headers);
  if(which==='DEC')  {
    mountMapUI('mapDEC', headers);
    // granular detector
    const names = headers.map(h=>normalizeHeader(h));
    state.isDecidirGranular = names.includes('order') || names.includes('numero de orden');
  }
  setKPI([`Cargado ${which}: ${data.length} filas`, ...(which==='DEC'?[`Decidir: ${state.isDecidirGranular?'granular por orden':'resumen por seller/mes'}`]:[])]);
}

/** Lookups **/
function buildTasaLookup(tasRows, map){
  // expect: Cuotas, TD% Con BSF, TD% Sin BSF
  const idx = {};
  tasRows.forEach(r=>{
    const cuotas = asNumber(r[map['Cuotas']]);
    const con = asNumber(r[map['TD% Con BSF']]);
    const sin = asNumber(r[map['TD% Sin BSF']]);
    if(!isNaN(cuotas)) idx[cuotas] = {con, sin};
  });
  return (cuotas, isBSF)=> {
    const row = idx[cuotas] || idx[parseInt(cuotas)||0] || {con:0, sin:0};
    return isBSF ? row.con : row.sin;
  };
}
function buildComisionLookup(comRows, map){
  // expect: Seller, Emisor/Brand, (opcional) Cuotas, Comisión (%)
  const table = [];
  comRows.forEach(r=>{
    table.push({
      seller: (r[map['Seller']]||'').toString().trim().toLowerCase(),
      emisor: (r[map['Emisor/Brand']]||'').toString().trim().toLowerCase(),
      cuotas: r[map['Cuotas']]!=null ? String(r[map['Cuotas']]).trim() : null,
      pct: asNumber(r[map['Comisión (%)']])
    });
  });
  return (seller, emisor, cuotas)=>{
    const s = (seller||'').toString().trim().toLowerCase();
    const e = (emisor||'').toString().trim().toLowerCase();
    const c = cuotas!=null ? String(cuotas).trim() : null;
    // priority: seller+emisor+cuotas -> seller+emisor -> seller -> generic
    let row = table.find(x=>x.seller===s && x.emisor===e && (x.cuotas===c));
    if(!row) row = table.find(x=>x.seller===s && x.emisor===e && (x.cuotas==null));
    if(!row) row = table.find(x=>x.seller===s && (x.emisor===''||x.emisor==='*'||x.emisor==='general'));
    if(!row) row = table.find(x=> (x.seller===''||x.seller==='*'||x.seller==='general') && (x.emisor===''||x.emisor==='*'||x.emisor==='general'));
    return row? row.pct : 0;
  };
}

/** Decidir helpers **/
function decideIsBSF(issuerText){
  const s = (issuerText||'').toString().toLowerCase();
  return s.includes('bsf') || s.includes('banco de servicios financieros');
}

/** Builder **/
function buildOutput(){
  state.maps.VTEX = grabMap('mapVTEX');
  state.maps.DEV  = grabMap('mapDEV');
  state.maps.COM  = grabMap('mapCOM');
  state.maps.TAS  = grabMap('mapTAS');
  state.maps.DEC  = grabMap('mapDEC');

  const periodo = document.getElementById('periodoLabel').value || '';
  const mesLabel = document.getElementById('mesLabel').value || '';
  const autoBSF = isTruthy(document.getElementById('detectarBSF').value==='si');

  const VTEX = state.raw.VTEX || [];
  const DEV  = state.raw.DEV  || [];
  const COM  = state.raw.COM  || [];
  const TAS  = state.raw.TAS  || [];
  const DEC  = state.raw.DEC  || [];

  // Build lookups
  const tasaFn = TAS.length ? buildTasaLookup(TAS, state.maps.TAS) : ()=>0;
  const comiFn = COM.length ? buildComisionLookup(COM, state.maps.COM) : ()=>0;

  // Index DEV (devoluciones) por Order
  const devIdx = {};
  DEV.forEach(r=>{
    const order = (r[state.maps.DEV['Order']] || r[state.maps.DEV['Numero de orden']] || '').toString().trim();
    if(!order) return;
    if(!devIdx[order]) devIdx[order] = {producto:0, desc:0, envio:0, total:0};
    devIdx[order].producto += asNumber(r[state.maps.DEV['Importe Producto']]);
    devIdx[order].desc     += asNumber(r[state.maps.DEV['Descuentos']]);
    devIdx[order].envio    += asNumber(r[state.maps.DEV['Envio']]);
    devIdx[order].total    += asNumber(r[state.maps.DEV['Importe Total']]);
  });

  // Decidir granular index
  const decidirByOrder = {};
  const decidirResumenSellerMes = {};
  if(DEC.length){
    if(state.isDecidirGranular){
      DEC.forEach(r=>{
        const order = (r[state.maps.DEC['Order']] || r[state.maps.DEC['Numero de orden']] || '').toString().trim();
        if(!order) return;
        decidirByOrder[order] = {
          issuer: r[state.maps.DEC['BIN/Issuer']] || r[state.maps.DEC['Brand']] || '',
          brand:  r[state.maps.DEC['Brand']] || '',
          cuotas: asNumber(r[state.maps.DEC['Cuotas']]),
          cfArs:  asNumber(r[state.maps.DEC['CF AR$']]),
          intCli: asNumber(r[state.maps.DEC['Interes Cliente AR$']]),
        };
      });
    } else {
      // resumen por seller / mes
      DEC.forEach(r=>{
        const seller = (r[state.maps.DEC['Seller']]||'').toString().trim().toLowerCase();
        const mes    = (r[state.maps.DEC['Mes']]||mesLabel).toString().trim().toLowerCase();
        const cfArs  = asNumber(r[state.maps.DEC['CF AR$']]);
        const intCli = asNumber(r[state.maps.DEC['Interes Cliente AR$']]);
        if(!seller) return;
        const key = seller+'||'+mes;
        if(!decidirResumenSellerMes[key]) decidirResumenSellerMes[key] = {cf:0, ic:0};
        decidirResumenSellerMes[key].cf += cfArs;
        decidirResumenSellerMes[key].ic += intCli;
      });
    }
  }

  // Sumarizar VTEX por orden y aplicar devoluciones
  const out = [];
  const sumBySellerMes = {}; // para prorrateo si Decidir es resumen
  VTEX.forEach(r=>{
    const numeroOrden = r[state.maps.VTEX['Numero de orden']];
    const order       = (r[state.maps.VTEX['Order']] || numeroOrden || '').toString().trim();
    if(!order) return;
    const tipoCbte    = r[state.maps.VTEX['Tipo de Comprobante']] || 'V';
    const fechaCbte   = r[state.maps.VTEX['Fecha de Comprobante']] || '';
    const prod        = asNumber(r[state.maps.VTEX['Importe Producto']]);
    const desc        = asNumber(r[state.maps.VTEX['Descuentos']]);
    const envio       = asNumber(r[state.maps.VTEX['Envio']]);
    let total         = r[state.maps.VTEX['Importe Total']]!=null ? asNumber(r[state.maps.VTEX['Importe Total']]) : (prod - desc + envio);
    let cuotas        = asNumber(r[state.maps.VTEX['Cantidad Total de Cuotas']]);
    let seller        = (r[state.maps.VTEX['Seller']]||'').toString().trim();
    let emisor        = r[state.maps.VTEX['Emisor']] || '';

    // aplicar devoluciones
    if(devIdx[order]){
      total -= devIdx[order].total;
      pushLog(`DEV aplicado a ${order}: -${devIdx[order].total.toFixed(2)}`);
    }

    // Decidir granular complementa
    let decidir = decidirByOrder[order] || null;
    if(decidir){
      if(!cuotas && decidir.cuotas) cuotas = decidir.cuotas;
      if(!emisor && decidir.issuer) emisor = decidir.issuer;
    }

    // determinar BSF
    let isBSF = false;
    if(autoBSF){
      isBSF = decideIsBSF(emisor);
    }

    // comisión % por seller+emisor(+cuotas)
    const pctCom = comiFn(seller, emisor, cuotas);
    const impCom = total * (pctCom || 0);

    // costo financiero
    let pctCF = tasaFn(cuotas||0, isBSF);
    let impCF = total * (pctCF || 0);

    // si Decidir granular trae CF AR$, pisar
    if(decidir && decidir.cfArs){
      impCF = decidir.cfArs;
      pctCF = total? (impCF/total) : 0;
      pushLog(`Decidir CF granular pisa CF en ${order}: CF=${impCF.toFixed(2)} (${fmtPct(pctCF)})`);
    }

    // intereses cliente
    let interesCli = decidir? decidir.intCli : 0;

    const totalSinImpuestos = total - impCom - impCF;

    const row = {
      'Fechas Liquidacion': mesLabel || periodo || '',
      'Numero de orden': numeroOrden || order,
      'Order': order,
      'Tipo de Comprobante': tipoCbte || 'V',
      'Fecha de Comprobante': fechaCbte,
      'Importe Producto': prod,
      'Descuentos': desc,
      'Envio': envio,
      'Importe Total': total,
      'Comisión (%)': pctCom || 0,
      'Importe Comisión (AR$)': impCom,
      'Cantidad Total de Cuotas': cuotas || 0,
      'Costo Financiero (%)': pctCF || 0,
      'Costo Financiero (AR$) asumido por el seller': impCF,
      'Intereses asumidos por el cliente': interesCli || 0,
      'Total sin impuestos': totalSinImpuestos,
      'Seller': seller
    };
    out.push(row);

    // acumular para prorrateo (Decidir resumen)
    const key = (seller||'').toString().trim().toLowerCase()+'||'+(mesLabel||'').toString().trim().toLowerCase();
    if(!sumBySellerMes[key]) sumBySellerMes[key] = {totalVTEX:0, idx:[]};
    sumBySellerMes[key].totalVTEX += total;
    sumBySellerMes[key].idx.push(out.length-1);
  });

  // prorrateo Decidir resumen por seller/mes
  if(Object.keys(decidirResumenSellerMes).length){
    Object.entries(decidirResumenSellerMes).forEach(([key,vals])=>{
      const bucket = sumBySellerMes[key];
      if(!bucket){ pushLog(`WARN: Decidir resumen ${key} sin matching en VTEX`); return; }
      const base = bucket.totalVTEX || 0;
      bucket.idx.forEach(i=>{
        const row = out[i];
        const w = base? (row['Importe Total']/base) : 0;
        const addCF = vals.cf * w;
        const addIC = vals.ic * w;

        if(addCF){
          const total = row['Importe Total'];
          row['Costo Financiero (AR$) asumido por el seller'] += addCF;
          const newPct = total? (row['Costo Financiero (AR$) asumido por el seller'] / total) : 0;
          row['Costo Financiero (%)'] = newPct;
        }
        if(addIC){
          row['Intereses asumidos por el cliente'] += addIC;
        }
        row['Total sin impuestos'] = row['Importe Total'] - row['Importe Comisión (AR$)'] - row['Costo Financiero (AR$) asumido por el seller'];
      });
      pushLog(`Decidir resumen aplicado ${key}: CF=${vals.cf.toFixed(2)} IC=${vals.ic.toFixed(2)} prorrateado en ${bucket.idx.length} órdenes`);
    });
  }

  state.outRows = out;
}

/** Export **/
function exportFile(){
  const fmt = document.getElementById('fmt').value || 'xlsx';
  const rows = state.outRows.map(r=>{
    // asegurar columnas y orden:
    const o={}; REQUIRED_OUTPUT_COLUMNS.forEach(c=>{ o[c]= (r[c]!==undefined ? r[c] : null); });
    return o;
  });

  if(fmt==='csv'){
    // simple CSV
    const header = REQUIRED_OUTPUT_COLUMNS.join(',');
    const body = rows.map(r=> REQUIRED_OUTPUT_COLUMNS.map(k=>{
      const v = r[k];
      if(typeof v === 'string'){
        return `"${v.replace(/"/g,'""')}"`;
      } else if(typeof v === 'number'){
        return String(v);
      } else return v==null?'':String(v);
    }).join(',')).join('\n');
    const csv = header+'\n'+body;
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    state.blob = blob;
  } else {
    // XLSX
    // Formateo: mostrar % como número (dejamos crudo, el usuario puede formatear)
    const ws = XLSX.utils.json_to_sheet(rows,{header:REQUIRED_OUTPUT_COLUMNS});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'LIQUIDACION');
    const out = XLSX.write(wb,{bookType:'xlsx',type:'array'});
    state.blob = new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  }
  document.getElementById('btnDescargar').disabled = false;
}

function downloadBlob(filename){
  if(!state.blob) return;
  saveAs(state.blob, filename);
}

/** Events **/
document.getElementById('fVTEX').addEventListener('change', e=> e.target.files[0] && handleLoad('VTEX', e.target.files[0]));
document.getElementById('fDEV').addEventListener('change', e=> e.target.files[0] && handleLoad('DEV', e.target.files[0]));
document.getElementById('fCOM').addEventListener('change', e=> e.target.files[0] && handleLoad('COM', e.target.files[0]));
document.getElementById('fTAS').addEventListener('change', e=> e.target.files[0] && handleLoad('TAS', e.target.files[0]));
document.getElementById('fDEC').addEventListener('change', e=> e.target.files[0] && handleLoad('DEC', e.target.files[0]));

document.getElementById('btnAnalizar').addEventListener('click', async ()=>{
  state.log = [];
  const need = ['VTEX'];
  const missing = need.filter(k=> !(state.raw[k] && state.raw[k].length));
  if(missing.length){ alert('Falta subir: '+missing.join(', ')); return; }
  buildOutput();
  setKPI([
    `Órdenes resultantes: ${state.outRows.length}`,
    `Decidir: ${Object.keys(state.raw.DEC||{}).length? (state.isDecidirGranular?'granular':'resumen/prorrateo'): 'no cargado'}`,
    `Comisiones: ${state.raw.COM? state.raw.COM.length:0} filas`,
    `Tasas: ${state.raw.TAS? state.raw.TAS.length:0} filas`
  ]);
  renderLogPreview();
});

document.getElementById('btnGenerar').addEventListener('click', async ()=>{
  state.log = [];
  const need = ['VTEX'];
  const missing = need.filter(k=> !(state.raw[k] && state.raw[k].length));
  if(missing.length){ alert('Falta subir: '+missing.join(', ')); return; }
  buildOutput();
  exportFile();
  renderLogPreview();
  setKPI([`Archivo listo: ${state.outRows.length} filas`, 'Revisá el Log si querés auditar los ajustes.']);
});

document.getElementById('btnDescargar').addEventListener('click', ()=>{
  const fmt = document.getElementById('fmt').value || 'xlsx';
  const periodo = (document.getElementById('periodoLabel').value||'').replace(/\s+/g,'_');
  const name = `LIQUIDACION_MKP_${periodo}.${fmt}`;
  downloadBlob(name);
});

document.getElementById('btnLog').addEventListener('click', ()=>{
  const csv = 'event\n' + (state.log||[]).map(x=> `"${String(x).replace(/"/g,'""')}"`).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  saveAs(blob,'log_transformaciones.csv');
});
</script>
</body>
</html>
